function preferOpus(a){for(var b=a.split("\r\n"),c=null,d=0;b.length>d;d++)if(-1!==b[d].search("m=audio")){c=d;break}if(null===c)return a;for(var e=0;b.length>e;e++)if(-1!==b[e].search("opus/48000")){var f=extractSdp(b[e],/:(\d+) opus\/48000/i);f&&(b[c]=setDefaultCodec(b[c],f));break}return b=removeCN(b,c),a=b.join("\r\n")}function extractSdp(a,b){var c=a.match(b);return c&&2==c.length?c[1]:null}function setDefaultCodec(a,b){for(var c=a.split(" "),d=[],e=0,f=0;c.length>f;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")}function removeCN(a,b){for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=extractSdp(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a}function mergeConstraints(a,b){var c=a;for(var d in b.mandatory)c.mandatory[d]=b.mandatory[d];return c.optional.concat(b.optional),c}var PeerConnection=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,URL=window.URL||window.webkitURL||window.msURL||window.oURL,getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,nativeRTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,nativeRTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};navigator.webkitGetUserMedia&&(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})),function(){var a;a="undefined"==typeof module?this.rtc={}:module.exports={},a.debug=!1,a._socket=null,a._me=null,a._events={},a.on=function(b,c){a._events[b]=a._events[b]||[],a._events[b].push(c)},a.fire=function(b){var d=a._events[b],e=Array.prototype.slice.call(arguments,1);if(d)for(var f=0,g=d.length;g>f;f++)d[f].apply(null,e)},a.SERVER=function(){return navigator.mozGetUserMedia?{iceServers:[{url:"stun:23.21.150.121"}]}:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},a.peerConnections={},a.connections=[],a.streams=[],a.numStreams=0,a.initializedStreams=0,a.dataChannels={},a.dataChannelConfig={optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]},a.pc_constraints={optional:[{DtlsSrtpKeyAgreement:!0}]},a.checkDataChannelSupport=function(){try{var b=new PeerConnection(a.SERVER(),a.dataChannelConfig),c=b.createDataChannel("supportCheck",{reliable:!1});return c.close(),!0}catch(d){return!1}},a.dataChannelSupport=a.checkDataChannelSupport(),a.connect=function(b,c){c=c||"",a._socket=new WebSocket(b),a._socket.onopen=function(){a._socket.send(JSON.stringify({eventName:"join_room",data:{room:c}})),a._socket.onmessage=function(b){var c=JSON.parse(b.data);a.fire(c.eventName,c.data)},a._socket.onerror=function(a){console.error("onerror"),console.error(a)},a._socket.onclose=function(){var c=a._socket.id;a.fire("disconnect stream",c),a.peerConnections[c]!==void 0&&a.peerConnections[c].close(),delete a.peerConnections[c],delete a.dataChannels[c],delete a.connections[c]},a.on("get_peers",function(b){a.connections=b.connections,a._me=b.you,a.offerSent&&(a.createPeerConnections(),a.addStreams(),a.addDataChannels(),a.sendOffers()),a.fire("connections",a.connections)}),a.on("receive_ice_candidate",function(b){var c=new nativeRTCIceCandidate(b);a.peerConnections[b.socketId].addIceCandidate(c),a.fire("receive ice candidate",c)}),a.on("new_peer_connected",function(b){var c=b.socketId;a.connections.push(c),delete a.offerSent;for(var d=a.createPeerConnection(c),e=0;a.streams.length>e;e++){var f=a.streams[e];d.addStream(f)}}),a.on("remove_peer_connected",function(b){var c=b.socketId;a.fire("disconnect stream",c),a.peerConnections[c]!==void 0&&a.peerConnections[c].close(),delete a.peerConnections[c],delete a.dataChannels[c],delete a.connections[c]}),a.on("receive_offer",function(b){a.receiveOffer(b.socketId,b.sdp),a.fire("receive offer",b)}),a.on("receive_answer",function(b){a.receiveAnswer(b.socketId,b.sdp),a.fire("receive answer",b)}),a.fire("connect")}},a.sendOffers=function(){for(var b=0,c=a.connections.length;c>b;b++){var d=a.connections[b];a.sendOffer(d)}},a.onClose=function(b){a.on("close_stream",function(){a.fire("close_stream",b)})},a.createPeerConnections=function(){for(var b=0;a.connections.length>b;b++)a.createPeerConnection(a.connections[b])},a.createPeerConnection=function(b){var c=a.pc_constraints;a.dataChannelSupport&&(c=a.dataChannelConfig);var d=a.peerConnections[b]=new PeerConnection(a.SERVER(),c);return d.onicecandidate=function(c){c.candidate&&a._socket.send(JSON.stringify({eventName:"send_ice_candidate",data:{label:c.candidate.sdpMLineIndex,candidate:c.candidate.candidate,socketId:b}})),a.fire("ice candidate",c.candidate)},d.onopen=function(){a.fire("peer connection opened")},d.onaddstream=function(c){a.fire("add remote stream",c.stream,b)},a.dataChannelSupport&&(d.ondatachannel=function(c){a.debug&&console.log("data channel connecting "+b),a.addDataChannel(b,c.channel)}),d},a.sendOffer=function(b){var c=a.peerConnections[b],d={optional:[],mandatory:{MozDontOfferDataChannel:!0}};if(navigator.webkitGetUserMedia)for(var e in d.mandatory)-1!=e.indexOf("Moz")&&delete d.mandatory[e];d=mergeConstraints(d,sdpConstraints),c.createOffer(function(d){d.sdp=preferOpus(d.sdp),c.setLocalDescription(d),a._socket.send(JSON.stringify({eventName:"send_offer",data:{socketId:b,sdp:d}}))},null,sdpConstraints)},a.receiveOffer=function(b,c){a.peerConnections[b],a.sendAnswer(b,c)},a.sendAnswer=function(b,c){var d=a.peerConnections[b];d.setRemoteDescription(new nativeRTCSessionDescription(c)),d.createAnswer(function(c){d.setLocalDescription(c),a._socket.send(JSON.stringify({eventName:"send_answer",data:{socketId:b,sdp:c}})),d.remoteDescription},null,sdpConstraints)},a.receiveAnswer=function(b,c){var d=a.peerConnections[b];d.setRemoteDescription(new nativeRTCSessionDescription(c))},a.createStream=function(b,c,d){var e;c=c||function(){},d=d||function(){},e={video:!!b.video,audio:!!b.audio},getUserMedia?(a.numStreams++,getUserMedia.call(navigator,e,function(b){a.streams.push(b),a.initializedStreams++,c(b),a.initializedStreams===a.numStreams&&a.fire("ready")},function(a){alert("Could not connect stream."),d(a)})):alert("webRTC is not yet supported in this browser.")},a.addStreams=function(){for(var b=0;a.streams.length>b;b++){var c=a.streams[b];for(var d in a.peerConnections)a.peerConnections[d].addStream(c)}},a.attachStream=function(b,c){"string"==typeof c&&(c=document.getElementById(c)),navigator.mozGetUserMedia?(a.debug&&console.log("Attaching media stream"),c.mozSrcObject=b,c.play()):c.src=webkitURL.createObjectURL(b)},a.createDataChannel=function(b,c){if(!a.dataChannelSupport)return alert("webRTC data channel is not yet supported in this browser, or you must turn on experimental flags"),void 0;var d,e;if("string"==typeof b)d=b,e=a.peerConnections[b];else{e=b,d=void 0;for(var f in a.peerConnections)a.peerConnections[f]===e&&(d=f)}if(!d)throw Error("attempt to createDataChannel with unknown id");if(!(e&&e instanceof PeerConnection))throw Error("attempt to createDataChannel without peerConnection");c=c||"fileTransfer"||d+"";var h,g={reliable:!1};try{a.debug&&console.log("createDataChannel "+d),h=e.createDataChannel(c,g)}catch(i){throw a.debug&&console.log("seems that DataChannel is NOT actually supported!"),i}return a.addDataChannel(d,h)},a.addDataChannel=function(b,c){return c.onopen=function(){a.debug&&console.log("data stream open "+b),a.fire("data stream open",c)},c.onclose=function(){delete a.dataChannels[b],delete a.peerConnections[b],delete a.connections[b],a.debug&&console.log("data stream close "+b),a.fire("data stream close",c)},c.onmessage=function(d){a.debug&&console.log("data stream message "+b),a.fire("data stream data",c,d.data)},c.onerror=function(d){a.debug&&console.log("data stream error "+b+": "+d),a.fire("data stream error",c,d)},a.dataChannels[b]=c,c},a.addDataChannels=function(){if(a.dataChannelSupport)for(var b in a.peerConnections)a.createDataChannel(b)},a.on("ready",function(){a.createPeerConnections(),a.addStreams(),a.addDataChannels(),a.sendOffers(),a.offerSent=!0})}.call(this);